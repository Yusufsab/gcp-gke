steps:
  # Pre-Build: Setup GCP, kubectl, Sentry, and dependencies
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Started..."
        gcloud auth configure-docker
        curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.23.16/2023-01-30/bin/linux/amd64/kubectl
        chmod +x ./kubectl
        mv ./kubectl /usr/local/bin/
        kubectl version --short --client

steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/kubernets-project-440302/gke-repo/quickstart-image', './app1' ]
  id: 'Build Docker Image'

  # images:
  # - 'us-central1-docker.pkg.dev/kubernets-project-440302/gke-repo/quickstart-image'

- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/kubernets-project-440302/gke-repo/quickstart-image' ]
  id: 'Push Docker Image'

- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/kubernets-project-440302/gke-repo/flask-image', './app2' ]
  id: 'Build Docker Image2'

  # images:
  # - 'us-central1-docker.pkg.dev/kubernets-project-440302/gke-repo/quickstart-image'

- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/kubernets-project-440302/gke-repo/flask-image' ]
  id: 'Push Docker Image2'


- name: 'google/cloud-sdk:latest'
  entrypoint: 'sh'
  args:
  - -xe
  - -c
  - |
    gcloud deploy apply --file deploy/pipeline.yaml --region=us-central1
    gcloud deploy apply --file deploy/dev.yaml --region=us-central1
    gcloud deploy apply --file deploy/dev.yaml --region=us-central1
# Deploy to GKE (Google Kubernetes Engine)
    gcloud deploy releases create app1-release-delivery-pipeline-gke-cird-pipeline-region-us-central1-from-k8s-manifest-/kubernetes/app2.yaml
    

  ##  gcloud deploy releases create app1-release-delivery-pipeline-gke-cird-pipeline-region-us-central1-from-k8s-manifest-/kubernetes/app1.yaml
  #  gcloud deploy releases create app1-release --project=kubernets-project-440302 --region=us-central1 --delivery-pipeline=delivery-pipeline-gke-cird-pipeline --annotations=build=1.0.0,env=production --description=delivery-pipeline-gke-cird-pipeline    gcloud deploy releases create app1-release-delivery-pipeline-gke-cird-pipeline-region-us-central1-from-k8s-manifest-/kubernetes/app2.yaml


options:
  logging: CLOUD_LOGGING_ONLY
